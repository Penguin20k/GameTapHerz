<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Tap Hearts</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<style>
  :root { color-scheme: light; --bg:#fce4ec; }
  html, body { margin:0; padding:0; height:100%; background:var(--bg); overflow:hidden; }
  canvas {
    display:block;
    width:100dvw;      
    height:100dvh;
    background:var(--bg);
    touch-action:none;
  }
  #hud{
    position:fixed; top:8px; left:0; right:0; display:flex; gap:14px; justify-content:center;
    font:700 22px/1.1 system-ui,-apple-system,Segoe UI,Roboto; color:#e91e63; text-shadow:1px 1px #fff;
    pointer-events:none; z-index:5;
  }
  #overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.5); z-index:10;
  }
  #card{
    background:#fff; padding:16px 18px; border-radius:12px; text-align:center;
    font:600 16px/1.25 system-ui,-apple-system,Segoe UI,Roboto; max-width:min(90vw,420px);
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  #btn{
    margin-top:10px; padding:10px 16px; border:0; border-radius:10px;
    background:#e91e63; color:#fff; font:700 18px system-ui; cursor:pointer;
  }
</style>
</head>
<body>
  <div id="hud">
    <div>‚ù§Ô∏è <span id="score">0</span></div>
    <div>üíî <span id="missed">0</span>/10</div>
    <div>üèÜ <span id="best">0</span></div>
  </div>

  <canvas id="game"></canvas>

  <div id="overlay">
    <div id="card">
      <div id="msg">–£–¥–∞—á–Ω–æ–π –∏–≥—Ä—ã –°–æ–ª–Ω—ã—à–∫–æ<br/>–∏ –≥–ª–∞–≤–Ω–æ–µ –Ω–µ —Å–∫—É—á–∞–π)</div>
      <button id="btn" type="button">–ò–≥—Ä–∞—Ç—å</button>
    </div>
  </div>

<script>
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const $score  = document.getElementById('score');
const $missed = document.getElementById('missed');
const $best   = document.getElementById('best');
const overlay = document.getElementById('overlay');
const msg     = document.getElementById('msg');
const btn     = document.getElementById('btn');

const WORLD = { w:0, h:0 };

function sizeCanvas() {
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const vw  = Math.round(window.innerWidth);
  const vh  = Math.round(window.visualViewport ? window.visualViewport.height : window.innerHeight);

  cvs.style.width  = vw + 'px';
  cvs.style.height = vh + 'px';

  cvs.width  = Math.round(vw * dpr);
  cvs.height = Math.round(vh * dpr);

  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  WORLD.w = vw;
  WORLD.h = vh;
}

function attemptFullscreen() {
  const el = document.documentElement;
  const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
  if (req) {
    try { req.call(el); } catch (e) { }
  }

  setTimeout(() => { window.scrollTo(0, 1); }, 250);
}

addEventListener('resize', sizeCanvas, { passive:true });
addEventListener('orientationchange', () => setTimeout(sizeCanvas, 200), { passive:true });
if (window.visualViewport) {
  visualViewport.addEventListener('resize', () => sizeCanvas(), { passive:true });
}

let playing = false;
let score = 0;
let missed = 0;
let best = +localStorage.getItem('taphearts_best') || 0;
$best.textContent = best;

let speed = 2;
let spawn = 0;
let frame = 0;
const MAX_SPEED = 10;

const hearts  = [];
const effects = [];

const redImg = new Image();
redImg.src = 'data:image/svg+xml;utf8,' +
  '<svg xmlns="http://www.w3.org/2000/svg" width="84" height="84">' +
  '<path d="M42 76s36-18 36-42a18 18 0 0 0-36 0 18 18 0 0 0-36 0c0 24 36 42 36 42z" fill="%23e91e63"/></svg>';

const blackImg = new Image();
blackImg.src = 'data:image/svg+xml;utf8,' +
  '<svg xmlns="http://www.w3.org/2000/svg" width="84" height="84">' +
  '<path d="M42 76s36-18 36-42a18 18 0 0 0-36 0 18 18 0 0 0-36 0c0 24 36 42 36 42z" fill="%23000"/></svg>';

function startGame() {
  score = 0; missed = 0;
  $score.textContent = score;
  $missed.textContent = missed;

  speed = 2; spawn = 0; frame = 0;
  hearts.length = 0;
  effects.length = 0;

  overlay.style.display = 'none';
  playing = true;

  attemptFullscreen();
}

function endGame() {
  playing = false;
  if (score > best) {
    best = score;
    localStorage.setItem('taphearts_best', best);
    $best.textContent = best;
  }
  msg.innerHTML = `–•–µ—Ö –∫–æ–Ω–µ—Ü<br/>‚ù§Ô∏è: ${score}`;
  overlay.style.display = 'flex';
}

function spawnHeart() {
  const size = 84;
  const type = Math.random() < 0.8 ? 'red' : 'black'; // 80% –∫—Ä–∞—Å–Ω—ã—Ö
  hearts.push({
    x: Math.random() * (WORLD.w - size),
    y: -size,
    w: size, h: size,
    type
  });
}

function addEffect(x, y, type) {
  if (type === 'red') {
    effects.push({ kind:'flash', x, y, r:12, a:1 });
  } else {
    for (let i=0; i<12; i++) {
      const ang = Math.random() * Math.PI * 2;
      const spd = 2 + Math.random() * 3;
      effects.push({
        kind:'particle', x, y,
        dx: Math.cos(ang)*spd, dy: Math.sin(ang)*spd,
        r: 4, a: 1
      });
    }
  }
}

function drawEffects() {
  for (let i = effects.length - 1; i >= 0; i--) {
    const e = effects[i];
    if (e.kind === 'flash') {
      e.r += 0.6; e.a -= 0.03;
      if (e.a <= 0) { effects.splice(i,1); continue; }
      ctx.fillStyle = `rgba(233,30,99,${e.a})`;
      ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
    } else {
      e.x += e.dx; e.y += e.dy; e.a -= 0.03; e.r *= 0.98;
      if (e.a <= 0) { effects.splice(i,1); continue; }
      ctx.fillStyle = `rgba(0,0,0,${e.a})`;
      ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
    }
  }
}

function loop() {
  requestAnimationFrame(loop);
  ctx.clearRect(0, 0, WORLD.w, WORLD.h);

  if (playing) {
    frame++;

    if (--spawn <= 0) {
      spawn = 16 + Math.random() * 16;
      spawnHeart();
    }

    let fall = speed + Math.min(5, score * 0.06);
    fall = Math.min(fall, MAX_SPEED);

    for (let i = hearts.length - 1; i >= 0; i--) {
      const h = hearts[i];
      h.y += fall;

      if (h.y > WORLD.h) {
        if (h.type === 'red') {
          missed++;
          $missed.textContent = missed;
          if (missed >= 10) { endGame(); return; }
        }
        hearts.splice(i, 1);
      }
    }

    if (frame % 600 === 0 && speed < MAX_SPEED) speed += 0.5;
  }

  ctx.imageSmoothingEnabled = false;
  for (const h of hearts) {
    ctx.drawImage(h.type === 'red' ? redImg : blackImg, h.x, h.y, h.w, h.h);
  }

  drawEffects();
}
loop();

function canvasPointFromEvent(e) {
  const rect = cvs.getBoundingClientRect();
  const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
  const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;
  return { x, y };
}

function tapAt(x, y) {
  for (let i = hearts.length - 1; i >= 0; i--) {
    const h = hearts[i];
    if (x >= h.x && x <= h.x + h.w && y >= h.y && y <= h.y + h.h) {
      if (h.type === 'red') {
        score++; $score.textContent = score;
        addEffect(h.x + h.w/2, h.y + h.h/2, 'red');
      } else {
        score = Math.max(0, score - 2);
        $score.textContent = score;
        addEffect(h.x + h.w/2, h.y + h.h/2, 'black');
      }
      hearts.splice(i,1);
      return true;
    }
  }
  return false;
}

cvs.addEventListener('pointerdown', (e) => {
  if (!playing) return;
  e.preventDefault();
  const p = canvasPointFromEvent(e);
  tapAt(p.x, p.y);
}, { passive:false });

function startFromOverlay() {
  sizeCanvas();
  startGame();
}
btn.addEventListener('click', startFromOverlay);

overlay.addEventListener('pointerdown', (e) => {
  if (e.target === overlay) startFromOverlay();
}, { passive:true });

sizeCanvas();
</script>
</body>
</html>
