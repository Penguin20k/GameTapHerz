<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Tap Hearts</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<style>
  :root { color-scheme: light; }
  html, body { margin:0; padding:0; height:100%; background:#fce4ec; overflow:hidden; }
  /* —Ö–æ–ª—Å—Ç —Ç—è–Ω–µ—Ç—Å—è –Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É; —Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∑–∞–¥–∞—ë—Ç JS */
  canvas { display:block; width:100svw; height:100svh; background:#fce4ec; touch-action:none; }
  #hud {
    position:fixed; inset:auto 0 auto 0; top:8px; display:flex; gap:14px; justify-content:center;
    font:700 22px/1.1 system-ui,-apple-system,Segoe UI,Roboto; color:#e91e63; text-shadow:1px 1px #fff;
    pointer-events:none; z-index:5;
  }
  #overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.5); z-index:10;
  }
  #card {
    background:#fff; padding:16px 18px; border-radius:12px; text-align:center;
    font:600 16px/1.25 system-ui,-apple-system,Segoe UI,Roboto; max-width:min(90vw,420px);
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  #btn {
    margin-top:10px; padding:10px 16px; border:0; border-radius:10px;
    background:#e91e63; color:#fff; font:700 18px system-ui; cursor:pointer;
  }
</style>
</head>
<body>
<div id="hud">
  <div>‚ù§Ô∏è <span id="score">0</span></div>
  <div>üèÜ <span id="best">0</span></div>
</div>
<canvas id="game"></canvas>

<div id="overlay">
  <div id="card">
    <div id="msg">–ù–∞–∂–∏–º–∞–π –Ω–∞ ‚ù§Ô∏è, –∏–∑–±–µ–≥–∞–π üñ§<br/>–ü—Ä–æ–ø—É—Å—Ç–∏—à—å ‚ù§Ô∏è ‚Äî –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã.</div>
    <button id="btn">–ò–≥—Ä–∞—Ç—å</button>
  </div>
</div>

<script>
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const $score = document.getElementById('score');
const $best  = document.getElementById('best');
const overlay = document.getElementById('overlay');
const msg = document.getElementById('msg');
const btn = document.getElementById('btn');

// --------- –†–∞–∑–º–µ—Ä—ã: —Ç–æ—á–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –ø–æ–¥ —ç–∫—Ä–∞–Ω –∏ DPR ---------
function sizeCanvas() {
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  // –ë–µ—Ä—ë–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –Ω–µ ¬´–ª–æ–º–∞–ª–æ—Å—å¬ª –∏–∑-–∑–∞ –ø–æ–ª–æ—Å –∞–¥—Ä–µ—Å–∞
  const vw = Math.round(window.innerWidth);
  const vh = Math.round(window.visualViewport ? window.visualViewport.height : window.innerHeight);

  // CSS —Ä–∞–∑–º–µ—Ä (–¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∫–∏)
  cvs.style.width  = vw + 'px';
  cvs.style.height = vh + 'px';

  // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∞–∑–º–µ—Ä (–ø–∏–∫—Å–µ–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
  cvs.width  = Math.round(vw * dpr);
  cvs.height = Math.round(vh * dpr);

  // –ú–∞—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–∞–∫, —á—Ç–æ–±—ã 1 –µ–¥–∏–Ω–∏—Ü–∞ = 1 CSS –ø–∏–∫—Å–µ–ª—å
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // –û–±–Ω–æ–≤–∏–º –∏–≥—Ä–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
  WORLD.w = vw;
  WORLD.h = vh;
}
addEventListener('resize', sizeCanvas, {passive:true});
addEventListener('orientationchange', () => setTimeout(sizeCanvas, 200), {passive:true});

// --------- –ú–∏—Ä –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---------
const WORLD = { w: 0, h: 0 };
let playing = false, score = 0, best = +localStorage.getItem('taphearts_best') || 0;
$best.textContent = best;

let speed = 2;          // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
let spawn = 0;          // —Ç–∞–π–º–µ—Ä —Å–ø–∞–≤–Ω–∞
let frame = 0;
const hearts = [];      // –æ–±—ä–µ–∫—Ç—ã —Å–µ—Ä–¥–µ—á–µ–∫
const effects = [];     // —á–∞—Å—Ç–∏—Ü—ã/–≤—Å–ø—ã—à–∫–∏

// --------- –¢–µ–∫—Å—Ç—É—Ä—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ, –æ—Ñ–ª–∞–π–Ω) ---------
const redImg = new Image();
redImg.src   = 'data:image/svg+xml;utf8,' +
  '<svg xmlns="http://www.w3.org/2000/svg" width="84" height="84">' +
  '<path d="M42 76s36-18 36-42a18 18 0 0 0-36 0 18 18 0 0 0-36 0c0 24 36 42 36 42z" fill="%23e91e63"/></svg>';
const blackImg = new Image();
blackImg.src  = 'data:image/svg+xml;utf8,' +
  '<svg xmlns="http://www.w3.org/2000/svg" width="84" height="84">' +
  '<path d="M42 76s36-18 36-42a18 18 0 0 0-36 0 18 18 0 0 0-36 0c0 24 36 42 36 42z" fill="%23000"/></svg>';

// --------- –ò–≥—Ä–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---------
function startGame() {
  score = 0; $score.textContent = score;
  speed = 2; frame = 0; spawn = 0;
  hearts.length = 0; effects.length = 0;
  overlay.style.display = 'none';
  playing = true;

  // –ü–æ–ø—Ä–æ–±—É–µ–º —Ñ—É–ª–ª—Å–∫—Ä–∏–Ω (–ø–æ –∫–ª–∏–∫—É —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}
function endGame() {
  playing = false;
  if (score > best) {
    best = score; localStorage.setItem('taphearts_best', best);
    $best.textContent = best;
  }
  msg.innerHTML = `Game Over<br/>–û—á–∫–∏: ${score}`;
  overlay.style.display = 'flex';
}

function spawnHeart() {
  const size = 84; // –±–æ–ª—å—à–∏–µ, —É–¥–æ–±–Ω–æ –∂–∞—Ç—å
  const type = Math.random() < 0.8 ? 'red' : 'black'; // 80% –∫—Ä–∞—Å–Ω—ã—Ö
  hearts.push({
    x: Math.random() * (WORLD.w - size),
    y: -size,
    w: size, h: size,
    type
  });
}

function addEffect(x, y, type) {
  if (type === 'red') {
    // –º—è–≥–∫–∞—è –≤—Å–ø—ã—à–∫–∞
    effects.push({ kind:'flash', x, y, r:12, a:1 });
  } else {
    // —á–∞—Å—Ç–∏—Ü—ã-–≤–∑—Ä—ã–≤
    for (let i=0;i<12;i++) {
      const ang = Math.random()*Math.PI*2;
      const spd = 2 + Math.random()*3;
      effects.push({ kind:'particle', x, y, dx:Math.cos(ang)*spd, dy:Math.sin(ang)*spd, r:4, a:1 });
    }
  }
}

function drawEffects() {
  for (let i=effects.length-1; i>=0; i--) {
    const e = effects[i];
    if (e.kind === 'flash') {
      e.r += 0.6; e.a -= 0.03;
      if (e.a <= 0) { effects.splice(i,1); continue; }
      ctx.fillStyle = `rgba(233,30,99,${e.a})`;
      ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
    } else {
      e.x += e.dx; e.y += e.dy; e.a -= 0.03; e.r *= 0.98;
      if (e.a <= 0) { effects.splice(i,1); continue; }
      ctx.fillStyle = `rgba(0,0,0,${e.a})`;
      ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
    }
  }
}

function loop() {
  requestAnimationFrame(loop);
  ctx.clearRect(0, 0, WORLD.w, WORLD.h);

  if (playing) {
    frame++;

    // —Å–ø–∞–≤–Ω —á–∞—Å—Ç–æ
    if (--spawn <= 0) {
      spawn = 16 + Math.random()*16; // —á–∞—â–µ, –¥–∏–Ω–∞–º–∏—á–Ω–æ
      spawnHeart();
    }

    const fall = speed + Math.min(5, score * 0.06); // —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

    // –∞–ø–¥–µ–π—Ç —Å–µ—Ä–¥–µ—Ü
    for (let i=hearts.length-1; i>=0; i--) {
      const h = hearts[i];
      h.y += fall;

      if (h.y > WORLD.h) {
        if (h.type === 'red') { endGame(); return; }
        else { hearts.splice(i,1); }
      }
    }

    // –ø–ª–∞–≤–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–∞–∑ –≤ ~10—Å
    if (frame % 600 === 0) speed += 0.5;
  }

  // —Ä–∏—Å—É–µ–º —Å–µ—Ä–¥—Ü–∞
  for (const h of hearts) {
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(h.type==='red' ? redImg : blackImg, h.x, h.y, h.w, h.h);
  }

  // —ç—Ñ—Ñ–µ–∫—Ç—ã
  drawEffects();
}
loop();

// --------- –¢–æ—á–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –ø–æ —Ç–∞–ø–∞–º (–≤ –ª—é–±–æ–π –∑–æ–Ω–µ) ---------
function canvasPointFromEvent(e) {
  const rect = cvs.getBoundingClientRect();
  // clientX/Y ‚Äî –≤ CSS-–ø–∏–∫—Å–µ–ª—è—Ö; –º—ã —Ä–∏—Å—É–µ–º –≤ —ç—Ç–∏—Ö –∂–µ –µ–¥–∏–Ω–∏—Ü–∞—Ö (–º–∞—Å—à—Ç–∞–± —É–∂–µ —É—á—Ç—ë–Ω)
  const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
  const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;
  return { x, y };
}

function tapAt(x, y) {
  for (let i=hearts.length-1; i>=0; i--) {
    const h = hearts[i];
    if (x >= h.x && x <= h.x+h.w && y >= h.y && y <= h.y+h.h) {
      if (h.type === 'red') {
        score++; $score.textContent = score; addEffect(h.x+h.w/2, h.y+h.h/2, 'red');
      } else {
        score = Math.max(0, score-2); $score.textContent = score; addEffect(h.x+h.w/2, h.y+h.h/2, 'black');
      }
      hearts.splice(i,1);
      return true;
    }
  }
  return false;
}

// pointer events —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –Ω–∞ iOS, –∏ –Ω–∞ Android
cvs.addEventListener('pointerdown', (e) => {
  if (!playing) return;
  e.preventDefault();
  const p = canvasPointFromEvent(e);
  tapAt(p.x, p.y);
}, {passive:false});

// —Å—Ç–∞—Ä—Ç
btn.addEventListener('click', () => {
  // –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä
  sizeCanvas();
  startGame();
});

// –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞
sizeCanvas();
</script>
</body>
</html>
